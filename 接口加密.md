# Identity Service接口安全

此文档为Identity Service接口安全。

## 设计
1. 接口加密
2. 数据库加密

### 接口加密
+ 我们在项目中使用到RSA，AES128，以及MD5，用以保证客户端(Client)和服务端(Server)之间的通信安全。
1. RSA——非对称加密，会产生公钥和私钥，公钥在客户端，私钥在服务端。公钥用于加密，私钥用于解密。
2. AES——对称加密，直接使用给定的秘钥加密，使用给定的秘钥解密。(加密解密使用相同的秘钥)

#### 流程

客户端上传数据加密 ==> 服务器获取数据解密 ==> 服务器返回数据加密 ==> 客户端获取数据解密

+ 客户端上传数据加密 A
1. 客户端随机产生一个16位的字符串，用以之后AES加密的秘钥，AESKey。
2. 使用RSA对AESKey进行公钥加密，RSAKey。
3. 重要的接口需要加签处理。
4. 将明文的要上传的数据包(字典/Map)转为Json字符串，使用AESKey加密，得到JsonAESEncryptedData。
5. 封装为{key : RSAKey, value : JsonAESEncryptedData}的字典上传服务器，服务器只需要通过key和value，然后解析，获取数据即可。

+ 服务器获取数据解密 B
1. 获取到RSAKey后用服务器私钥解密，获取到AESKey
2. 获取到JsonAESEncriptedData，使用AESKey解密，得到明文的客户端上传上来的数据
3. 如果客户端进行了加签处理，此处需要验签，以保证数据在网络传输过程中是否被篡改

+ 服务器返回数据加密 C
1. 将要返回给客户端的数据(字典/Map)转成Json字符串，用AESKey加密处理
2. 如需要可以加签处理
3. 封装数据{data : value}的形式返回给客户端

+ 客户端获取数据解密 D
1. 客户端获取到数据后通过key为data得到服务器返回的已经加密的数据AESEncryptedResponseData
2. 对AESEncryptedResponseData使用AESKey进行解密，得到明文服务器返回的数据。

#### 加签和验签
防止数据被篡改
+ 加签处理(数据发起方都可以加签，此处是客户端)
1. 我们一般取其中的关键字段(别人可能修改的字段)，比如此时step，和time及memberId，都比较敏感。
2. 在上文的A中的第二步之后，获取step，time，memberId，拼接成一个字符串(顺序和服务器约定好)，然后使用md5加密，采用base64编码(编码格式和服务约定)。得到signData
3. 然后将获取到的signData以key-value的形式保存到原来明文的数据包中，然后进行A的第三步

+ 验签处理(数据接受方都可以验签，此处服务端)
1. 如上，到B的第三步，此时已经得到了客户端上传的明文数据
2. 按照喝客户端约定的字段拼接，将得到的step，time，memberId拼接后，使用同样的md5_base64处理，然后比较数据包中的签名sign是否和客户端当时的签名一致。
3. 如果一致，接受数据。不一致，抛弃数据，终止本次操作

> 假设加签之后的数据包被截获，然后解密成功，得到明文的数据包。但是签名md5加密是无法解密的(单向加密)。此时即时修改了step，然后post到服务器，服务器通过修改后的step，time，memberId得到的字符串经过md5加密后，一定会与客户端的签名不一致。从而数据被抛弃。

流程图描述上文

![流程图](%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg)

### 数据库加密
我们不会保存用户的密码，在数据库中存放的是密码的hash，校验数据是根据密码hash是否一致来判断。

